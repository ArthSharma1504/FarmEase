<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Our App</title>
   <link rel="stylesheet" href="{{url_for('static',filename='styles/welcome.css')}}">
</head>
<body>

    <video autoplay muted loop>
        <source src="{{ url_for('static', filename='videos/old.mp4') }}" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="next-button" onclick="window.location.href='{{ url_for('my_Profile') }}';">
        <h1>मेरी प्रोफाइल</h1>
        <p>मम कार्याणि</p>
    </div>

    <div class="container">
        <div class="option-box" onclick="window.location.href='{{ url_for('show_weather') }}';">
            <h1>मौसम दिखाएं</h1>
            <p>मौसम का पूर्वानुमान देखने के लिए क्लिक करें।</p>
        </div>
        
        <div class="option-box" onclick="window.location.href='{{ url_for('crop_recommendations') }}';">
            <h1>फसल की जानकारी</h1>
            <p>मिट्टी की परत विवरण देखने के लिए क्लिक करें।</p>
        </div>
        
        <div class="option-box" onclick="window.location.href='{{ url_for('government_schemes') }}';">
            <h1>सरकारी योजनाएँ</h1>
            <p>सरकारी योजनाओं का पता लगाने के लिए क्लिक करें।</p>
        </div>
    </div>

    <!-- Display the logged-in user's details -->
    {% if username %}
    <div class="user-info">
        Logged in as: {{ username }} |
        <a href="{{ url_for('logout') }}" style="color: #fff;">Logout</a>
    </div>
    {% else %}
    <div class="user-info">
        <a href="{{ url_for('login') }}" style="color: #fff;">Login</a> |
        <a href="{{ url_for('register') }}" style="color: #fff;">Register</a>
    </div>
    {% endif %}

    <div class="notification-bell">
        <div class="bell-icon" id="bell-icon"></div>
        <div class="notification-popup" id="notification-popup">
            <h4>Weather Updates</h4>
            <div id="weather-notification">No new notifications</div>
        </div>
    </div>
    

    <script>
       document.getElementById('bell-icon').addEventListener('click', function () {
    const popup = document.getElementById('notification-popup');
    popup.classList.toggle('visible'); // Toggles visibility on click
});

// Function to check for new weather updates and show notification
function checkWeatherNotification() {
    console.log('checkWeatherNotification fired'); // Check if the function is called

    fetch('{{ url_for("get_weather_notifications") }}')
        .then(response => response.json())
        .then(data => {
            console.log('Weather Notification Data:', data);  // Log the full response

            const bellIcon = document.getElementById('bell-icon');
            const weatherNotification = document.getElementById('weather-notification');

            if (data.has_new_update) {
                // Case with a new weather alert
                bellIcon.classList.add('alert');
                weatherNotification.innerText = data.notification_message;
            } else {
                // Case with no new alerts, display current weather
                bellIcon.classList.remove('alert');
                if (data.notification_message) {
                    weatherNotification.innerText = `Current weather: ${data.notification_message}`;
                } else {
                    weatherNotification.innerText = "No new notifications.";
                }
            }
        })
        .catch(error => {
            console.error('Error fetching weather notification:', error);
            document.getElementById('weather-notification').innerText = "Error fetching weather updates.";
        });
}

// Periodically check for new notifications every 60 seconds
setInterval(checkWeatherNotification, 60000); // Check every 60 seconds

    </script>
    

<!-- to ask for permission -->

<script>
    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;

                    // Send location data to the backend
                    fetch('/update_user_location', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ latitude, longitude }),
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            console.log('City set to:', data.city);
                        } else {
                            console.error('Failed to set city:', data.error);
                        }
                    })
                    .catch((error) => console.error('Error sending location data:', error));
                },
                (error) => {
                    console.error('Error getting user location:', error.message);
                }
            );
        } else {
            console.error('Geolocation is not supported by this browser.');
        }
    }

    // Trigger location fetch on page load
    window.onload = getUserLocation;
</script>


</body>
</html>
